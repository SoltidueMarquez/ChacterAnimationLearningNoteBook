## 任务：

看一下generatedatabase.py具体是怎么读入bvh以及处理地形数据

以LocomotionFlat01_000.bvh为例：

1.手动打gait label生成LocomotionFlat01_000.gait.txt；

2.调用gait_v3.py生成LocomotionFlat01_000.gait；

3.preprocess_footstep_phase.py生成LocomotionFlat01_000.footsteps.txt和LocomotionFlat01_000.phase

4.跑完了和data里面的对比一下看看是不是一样的

![image-20250704231035291](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704231035291.png)





## AI：

### 关键处理流程详解

1. **数据加载与预处理**
   - 加载BVH动画文件和对应的步态参数
   - 缩放骨骼尺寸到真实世界单位（米）
   - 降采样减少数据量
2. **运动特征提取**
   - 计算全局骨骼位置和旋转
   - 确定角色前进方向
   - 转换到以根骨骼为中心的局部坐标系
   - 检测脚部触地状态
   - 构建包含轨迹、姿态、步态的特征向量
3. **地形拟合**
   - 根据脚部触地点反推地形高度
   - 使用RBF插值器修正地形残差
   - 特殊地形处理（跳跃/独木桥）
   - 在根骨骼轨迹上采样地形高度
4. **步态周期对齐**
   - 使用脚步标记文件划分步态周期
   - 为每个周期生成多个地形变体
   - 调整高度信息使其相对化
5. **数据库构建**
   - 合并所有片段数据
   - 保存为压缩的NPZ格式
   - 包含输入特征(Xun)、输出目标(Yun)和相位信息(Pun)

### 生成的数据结构

1. **输入特征 (Xun)**
   - 轨迹位置/方向历史
   - 步态参数
   - 关节位置/速度
   - 地形高度特征
2. **输出目标 (Yun)**
   - 根骨骼速度/旋转速度
   - 相位变化
   - 脚部触地状态
   - 未来轨迹位置/方向
   - 关节位置/速度/旋转
3. **相位信息 (Pun)**
   - 标准化的步态周期相位（0.0-1.0）

这个处理流程生成了一个包含运动学、步态和地形信息的综合数据库，适用于训练地形自适应的角色运动生成模型。



### 主要流程

`generate_database.py` 脚本处理 BVH 动画数据并生成训练数据库，主要流程如下：

### 1. BVH 数据加载与预处理

![image-20250704231649392](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704231649392.png)

- 使用自定义 `BVH.load()` 加载 BVH 文件
- 通过 `to_meters=5.6444` 比例因子将动画缩放到真实世界尺寸
- 降采样减少数据量

### 2. 辅助数据加载

![image-20250704231736454](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704231736454.png)

- 加载预计算的步态相位（0-1周期值）
- 加载步态参数向量（行走/跑步/下蹲等状态）

### 3. 运动数据处理核心流程

**a. 计算全局变换**

![image-20250704231937597](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704231937597.png)

- 计算骨骼的全局变换矩阵
- 提取全局3D位置

**b. 确定前进方向**

![image-20250704232051126](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704232051126.png)

- 使用肩部和髋部位置确定角色朝向
- 高斯滤波平滑方向向量

**c. 坐标转换到局部空间**

![image-20250704232410922](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704232410922.png)

- 将全局坐标转换为以根骨骼为原点的局部坐标
- 计算局部速度和旋转量

**d. 脚部触地检测**

![image-20250704232542477](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704232542477.png)

- 通过脚部移动距离阈值（0.02单位）检测触地状态

### 4. 地形数据处理

**a. 地形块加载**

![image-20250704232641275](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704232641275.png)

- 从 patches.npz 加载预定义地形高度网格

**b. 地形高度采样函数**

![image-20250704232943522](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704232943522.png)

- 使用双线性插值在连续坐标点获取地形高度

**c. 地形拟合（关键步骤）**

![image-20250704233148324](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704233148324.png)

- 根据脚部触地点位置反推地形高度
- 使用径向基函数（RBF）插值器修正地形
- 特殊地形逻辑（如跳越地形/独木桥）

**d. 轨迹高度计算**

![image-20250704233118292](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704233118292.png)

- 在根骨骼位置及其左右偏移点采样地形高度
- 构建轨迹高度特征向量

### 5. 数据窗口化处理

python

```
for i in range(window, len(anim)-window-1):
    # 构建包含以下元素的输入向量X：
    # - 历史/未来轨迹位置
    # - 步态参数
    # - 关节位置/速度
    # - 地形高度特征
```

![image-20250704233246191](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704233246191.png)

- 以滑动窗口方式截取动画片段
- 每个窗口包含60帧历史+60帧未来数据

### 6. 步态周期对齐

python

```
with open(_footsteps.txt) as f:  # 加载脚步标记
    footsteps = f.readlines()

for li in range(len(footsteps)-1):
    # 只处理完整步态周期（排除带*的标记）
    slc = slice(当前步起始, 下一步起始)
```

![image-20250704233343981](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704233343981.png)

- 使用 `_footsteps.txt` 文件中的时间标记对齐步态周期
- 仅处理完整周期（排除带星号*的无效周期）

### 7. 数据库生成

![image-20250704233412944](./%E4%BB%A3%E7%A0%81%E7%A0%94%E8%AF%BB/image-20250704233412944.png)

最终生成包含：

- `Xun`：输入特征（轨迹/姿态/地形等）
- `Yun`：输出目标（未来运动状态）
- `Pun`：步态相位信息

### 关键设计特点

1. **多地形支持**：通过 `type` 参数区分平地/崎岖/跳跃/独木桥地形
2. **物理校准**：使用真实世界单位（米）处理位置数据
3. **数据增强**：包含原始动画和镜像动画
4. **步态感知**：利用相位信息保持周期一致性
5. **地形适应**：通过脚部接触点动态拟合地形高度

此流程最终生成用于训练运动生成模型的密集时空特征数据库，结合了运动学、步态和地形信息。